import java.util.jar.JarFile
import org.yaml.snakeyaml.Yaml

apply plugin: 'java'
apply plugin: 'groovy'
// apply plugin: 'maven'
apply plugin: 'maven-publish'
apply plugin: 'com.jfrog.artifactory'

repositories {
    mavenCentral()
    mavenLocal()
}

buildscript {
dependencies{
        classpath("org.yaml:snakeyaml:2.0")
    }
    repositories {
        maven {
            url 'https://jfrog.rosenvold.tech/artifactory/plugins'
            credentials {
                username = "admin" // Your Artifactory username
                password = "cmVmdGtuOjAxOjE3Mjk1MTA3OTY6Q2FsdUxPME5ubmFwcGZFbHJGT1Z2dkJLOHZt" // Your Artifactory password
            }
        }
        mavenCentral()
    }
    // dependencies { classpath "org.jfrog.buildinfo:build-info-extractor-gradle:4.5.4" }
}

buildscript {
    repositories {
        maven {
            url 'https://plugins.gradle.org/m2/'
        }
    }
    dependencies {
        classpath 'org.jfrog.buildinfo:build-info-extractor-gradle:5.1.9'
    }
}

ext.filesToPublish = []
ext.dir = new File("_plugins")
def files = ext.dir.listFiles().findAll { it.isFile() && it.name.endsWith('.jar') }

files.each { file ->
    ext.filesToPublish << file
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java

            filesToPublish.each { file ->
                def jarFile = new JarFile(file)
                def pluginYml = (jarFile.getEntry("plugin.yml") != null) ? jarFile.getEntry("plugin.yml") : jarFile.getEntry("bungee.yml")
                if (pluginYml != null) {
                    def yaml = new Yaml()
                    def plugin = yaml.load(jarFile.getInputStream(pluginYml))
                    def ARTIFACT_ID = plugin.name
                    def ARTIFACT_VERSION = plugin.version.toString()
                    if (ARTIFACT_VERSION.contains(" ")) {
                        ARTIFACT_VERSION = ARTIFACT_VERSION.replace(" ", "-")
                    }
                    def ARTIFACT_GROUP = plugin.name

                    groupId ARTIFACT_GROUP
                    artifactId ARTIFACT_ID
                    version ARTIFACT_VERSION

                    // Publish the JAR file as an artifact
                    artifact(file)

                    println("Published $ARTIFACT_ID version $ARTIFACT_VERSION")
                }
            }
        }
    }

    repositories {
        maven {
            url 'https://jfrog.rosenvold.tech/artifactory/plugins'
            credentials {
                username = "admin" // Your Artifactory username
                password = "cmVmdGtuOjAxOjE3Mjk1MTA3OTY6Q2FsdUxPME5ubmFwcGZFbHJGT1Z2dkJLOHZt" // Your Artifactory API key or password
            }
        }
    }
}

artifactory {
    contextUrl = "https://jfrog.rosenvold.tech/artifactory"
    publish {
        repository {
            repoKey = 'plugins'
            username = "admin" // Your Artifactory username
            password = "cmVmdGtuOjAxOjE3Mjk1MTA3OTY6Q2FsdUxPME5ubmFwcGZFbHJGT1Z2dkJLOHZt" // Your Artifactory API key or password
        }
        defaults {
            publications('mavenJava')
        }
    }
}